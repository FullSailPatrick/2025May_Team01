name: Commit feed to Discord

on:
  push:
    branches:
      - "**"          # run on every branch push

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
    # 1 Checkout the repo so we can read commit data
    - name: Checkout repo
      uses: actions/checkout@v4

    # 2 Gather details about this push
    - name: Get commit data
      id: build
      run: |
        echo "Repo=${{ github.repository }}"             >> $GITHUB_ENV
        echo "Branch=${GITHUB_REF##*/}"                  >> $GITHUB_ENV
        echo "Author=${{ github.event.pusher.name }}"    >> $GITHUB_ENV
        echo "Timestamp=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
        echo "CommitInfo=$(git log -1 --pretty=format:'%h %s')" >> $GITHUB_ENV
        echo "Link=${{ github.event.compare }}"          >> $GITHUB_ENV

    # 3 Post a nicely-formatted message to Discord
    - name: Post to Discord
      env:
        WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        cat > message.txt <<'EOF'
:white_check_mark: GitHub push detected
Repo: $Repo
Branch: $Branch
Author: $Author
Time: $Timestamp
Commit: $CommitInfo
Link: $Link
EOF

        PAYLOAD=$(jq -Rs '{content: .}' < message.txt)
        curl -s \
          -H "Content-Type: application/json" \
          -d "$PAYLOAD" \
          "$WEBHOOK"
