name: Commit feed to Discord

on:
  push:
    branches:
      - '**'          # run on every push to any branch

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
    # 1  Check out the repo (so we can read commit data)
    - name: Checkout repo
      uses: actions/checkout@v4

    # 2  Collect details about this push and put them in env-vars
    - name: Get commit data
      id: get_data
      run: |
        echo "Repo=${{ github.repository }}"      >> "$GITHUB_ENV"
        echo "Branch=${GITHUB_REF##*/}"           >> "$GITHUB_ENV"
        echo "Author=${{ github.event.pusher.name }}" >> "$GITHUB_ENV"
        echo "Timestamp=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "$GITHUB_ENV"
        echo "CommitInfo=$(git log -1 --pretty=format:'%h %s')" >> "$GITHUB_ENV"
        echo "Link=${{ github.event.compare }}"   >> "$GITHUB_ENV"

    # 3  Post a nicely-formatted message to Discord
    - name: Post to Discord
      env:
        WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        # build the message
        cat > message.txt <<EOF
        :white_check_mark: GitHub push detected
        Repo:   $Repo
        Branch: $Branch
        Author: $Author
        Time:   $Timestamp
        Commit: $CommitInfo
        Link:   $Link
        EOF

        # send it
        PAYLOAD=$(jq -Rs '{content: .}' < message.txt)
        curl -s -H "Content-Type: application/json" \
             -d "$PAYLOAD" "$WEBHOOK"
